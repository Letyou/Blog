# 微信小程序 web-view 上传图片的踩坑之旅

> 记录踩坑过程中的点点滴滴

## 事情起因

> 用户使用安卓手机上传图片触发按钮无效，无任何反应，衍生出来的一个问题，用户使用第三方录制软件生成的视频，在手机内显示.mp4 格式，上传到服务端会变成.tmp 后缀的文件格式，且服务端接收到的文件是以 xxx 的文件，并没有后缀名。

## 问题排查

Question: input assept 属性设置的 video/\* 没有限制死用户上传格式，导致用户可以选择进行上传.tmp 格式。❌
Answer: 尝试过修改对应的限制条件，但是发现会影响到部分手机，本身可以上传的视频格式反倒不可以上传了。
Question: 通过 input 上传的时候，微信 web-view 进行了一次格式转换，导致上传到服务端和 oss 异常。❌
Answer: 经多方测试，正常拍照上传和文件选择并不会因为微信本身修改了格式。
Question: 根据上传的文件名称以及格式，判断因为手机机型导致的文件格式异常。✅

## 最终解决

在上传函数内新增一个校验规则，拒绝用户上传无后缀的文件名，导致服务端和 oss 返回 null
这个问题体现了部分潜在问题，前后端并没有精确上传文件的格式，如果这个 tmp 格式文件被注入了病毒或者木马，如果上传成功了，会导致不必要的损失
从安全问题角度来说，涉及到数据库或者 oss 的操作，还需要多谨慎处理。

## 勘误及提问

如果有疑问或者发现错误，可以在相应的 issues 进行提问或勘误。

如果喜欢或者有所启发，欢迎 star，对作者也是一种鼓励。

## License

所有文章采用[知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议](http://creativecommons.org/licenses/by-nc-sa/3.0/cn/)进行许可。
